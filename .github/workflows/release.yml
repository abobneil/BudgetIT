name: Release (Windows)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing git tag to build and publish (example: v1.2.3)"
        required: true
        type: string
      draft:
        description: "Publish release as draft"
        required: false
        default: true
        type: boolean

concurrency:
  group: release-${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  preflight:
    name: Preflight
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.resolve-tag.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve release tag
        id: resolve-tag
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          else
            if [[ -z "${{ github.event.inputs.tag }}" ]]; then
              echo "workflow_dispatch requires a tag input." >&2
              exit 1
            fi
            echo "tag=${{ github.event.inputs.tag }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Validate tag exists
        shell: bash
        run: |
          git fetch --tags --force
          git rev-parse "${{ steps.resolve-tag.outputs.tag }}" >/dev/null

      - name: Validate project scaffold
        shell: bash
        run: |
          if [[ ! -f package.json ]]; then
            echo "package.json is required for release workflow." >&2
            exit 1
          fi

      - name: Ensure pushed tag commit is on main
        if: github.event_name == 'push'
        shell: bash
        run: |
          git fetch origin main
          if ! git branch -r --contains "$GITHUB_SHA" | grep -q "origin/main"; then
            echo "Tag commit is not contained in origin/main." >&2
            exit 1
          fi

  build-windows:
    name: Build Windows Installer
    needs: preflight
    runs-on: windows-latest
    timeout-minutes: 60
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      CSC_LINK: ${{ secrets.CSC_LINK }}
      CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
      WIN_CSC_LINK: ${{ secrets.WIN_CSC_LINK }}
      WIN_CSC_KEY_PASSWORD: ${{ secrets.WIN_CSC_KEY_PASSWORD }}
    steps:
      - name: Checkout tag
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.preflight.outputs.tag }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: |
            package-lock.json
            **/package-lock.json

      - name: Install dependencies
        shell: bash
        run: |
          if [[ -f package-lock.json ]]; then
            npm ci
          else
            npm install
          fi

      - name: Validate npm scripts
        shell: bash
        run: |
          node -e "const fs=require('fs'); const pkg=JSON.parse(fs.readFileSync('package.json','utf8')); const required=['lint','typecheck','test','build']; const missing=required.filter((n)=>!pkg.scripts||!pkg.scripts[n]); if(missing.length){console.error('Missing required scripts: '+missing.join(', ')); process.exit(1);} const releaseCandidates=['release:win','dist:win','package:win','dist']; if(!releaseCandidates.find((n)=>pkg.scripts&&pkg.scripts[n])){console.error('Missing release script. Add one of: '+releaseCandidates.join(', ')); process.exit(1);} console.log('Required scripts validated.');"

      - name: Resolve release script
        id: release-script
        shell: bash
        run: |
          release_script="$(node -e "const fs=require('fs'); const pkg=JSON.parse(fs.readFileSync('package.json','utf8')); const candidates=['release:win','dist:win','package:win','dist']; const found=candidates.find((n)=>pkg.scripts&&pkg.scripts[n]); process.stdout.write(found||'');")"
          if [[ -z "$release_script" ]]; then
            echo "Could not resolve a release script." >&2
            exit 1
          fi
          echo "script=$release_script" >> "$GITHUB_OUTPUT"
          echo "Using npm script: $release_script"

      - name: Lint
        run: npm run lint

      - name: Typecheck
        run: npm run typecheck

      - name: Test
        run: npm run test

      - name: Build
        run: npm run build

      - name: Build release artifacts
        run: npm run ${{ steps.release-script.outputs.script }}

      - name: Collect release artifacts and checksums
        shell: powershell
        run: |
          New-Item -ItemType Directory -Path release-artifacts -Force | Out-Null

          $patterns = @(
            "dist\\*.exe",
            "dist\\*.msi",
            "dist\\*.zip",
            "dist\\*.blockmap",
            "dist\\latest*.yml",
            "dist\\*.yaml",
            "dist\\*.json"
          )

          $files = @()
          foreach ($pattern in $patterns) {
            $files += Get-ChildItem -Path $pattern -File -ErrorAction SilentlyContinue
          }

          $uniqueFiles = $files | Sort-Object FullName -Unique
          if (-not $uniqueFiles -or $uniqueFiles.Count -eq 0) {
            throw "No release artifacts were found in dist/."
          }

          foreach ($file in $uniqueFiles) {
            Copy-Item -Path $file.FullName -Destination (Join-Path "release-artifacts" $file.Name) -Force
          }

          $checksumPath = Join-Path "release-artifacts" "SHA256SUMS.txt"
          if (Test-Path $checksumPath) {
            Remove-Item $checksumPath -Force
          }

          $artifactFiles = Get-ChildItem -Path release-artifacts -File | Where-Object { $_.Name -ne "SHA256SUMS.txt" } | Sort-Object Name
          foreach ($artifact in $artifactFiles) {
            $hash = (Get-FileHash -Path $artifact.FullName -Algorithm SHA256).Hash.ToLower()
            "$hash  $($artifact.Name)" | Add-Content -Path $checksumPath
          }

      - name: Upload release artifact bundle
        uses: actions/upload-artifact@v4
        with:
          name: windows-release-artifacts-${{ needs.preflight.outputs.tag }}
          path: release-artifacts/**
          if-no-files-found: error

  publish-release:
    name: Publish GitHub Release
    needs:
      - preflight
      - build-windows
    runs-on: ubuntu-latest
    steps:
      - name: Download artifact bundle
        uses: actions/download-artifact@v4
        with:
          name: windows-release-artifacts-${{ needs.preflight.outputs.tag }}
          path: release-artifacts

      - name: Create or update release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.preflight.outputs.tag }}
          name: BudgetIT ${{ needs.preflight.outputs.tag }}
          draft: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.draft == 'true' }}
          generate_release_notes: true
          files: release-artifacts/*
