name: Release (Windows)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing git tag to publish (example: v0.1.0)"
        required: true
        type: string
      draft:
        description: "Publish release as draft"
        required: false
        default: true
        type: boolean

concurrency:
  group: release-${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  preflight:
    name: Resolve Tag
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag.outputs.value }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve release tag
        id: tag
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "value=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          else
            echo "value=${{ github.event.inputs.tag }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Validate tag exists
        shell: bash
        run: |
          git fetch --tags --force
          git rev-parse "${{ steps.tag.outputs.value }}" >/dev/null

      - name: Ensure pushed tag commit is on main
        if: github.event_name == 'push'
        shell: bash
        run: |
          git fetch origin main
          if ! git branch -r --contains "$GITHUB_SHA" | grep -q "origin/main"; then
            echo "Tag commit is not contained in origin/main." >&2
            exit 1
          fi

  package:
    name: Build NSIS Installer
    needs: preflight
    runs-on: windows-latest
    timeout-minutes: 60
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      CSC_LINK: ${{ secrets.CSC_LINK }}
      CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
      WIN_CSC_LINK: ${{ secrets.WIN_CSC_LINK }}
      WIN_CSC_KEY_PASSWORD: ${{ secrets.WIN_CSC_KEY_PASSWORD }}
    steps:
      - name: Checkout tag
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.preflight.outputs.tag }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: |
            package-lock.json
            **/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Quality gates
        run: |
          npm run lint
          npm run typecheck
          npm run test
          npm run build

      - name: Build release artifacts
        run: npm run release:win

      - name: Validate artifacts and create checksum
        shell: powershell
        run: |
          $artifacts = Get-ChildItem -Path dist/release -File -ErrorAction SilentlyContinue
          if (-not $artifacts -or $artifacts.Count -eq 0) {
            throw "No release artifacts found in dist/release."
          }

          $checksumPath = "dist/release/SHA256SUMS.txt"
          if (Test-Path $checksumPath) {
            Remove-Item $checksumPath -Force
          }

          foreach ($artifact in ($artifacts | Sort-Object Name)) {
            $hash = (Get-FileHash -Path $artifact.FullName -Algorithm SHA256).Hash.ToLower()
            "$hash  $($artifact.Name)" | Add-Content -Path $checksumPath
          }

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release-${{ needs.preflight.outputs.tag }}
          path: dist/release/**
          if-no-files-found: error

  publish:
    name: Publish GitHub Release
    needs:
      - preflight
      - package
    runs-on: ubuntu-latest
    steps:
      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-release-${{ needs.preflight.outputs.tag }}
          path: dist/release

      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.preflight.outputs.tag }}
          name: BudgetIT ${{ needs.preflight.outputs.tag }}
          draft: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.draft == 'true' }}
          generate_release_notes: true
          files: dist/release/*

